{% extends 'main.html' %}
{% load static %}

{% block content %}

<div class="product-form-container">


    <div class="pf-image-side">
        <img src="{% static 'images/add-product-img.png' %}" alt="Side Image">
    </div>

    <div class="product-form">
        <form method="post" action="{% url 'product-form' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <h2>Add Product</h2>
            <label>Product Name</label>
            <input type="text" name="p_name" placeholder="Enter product name" required>

            <label>Price (NRP.)</label>
            <input type="number" name="price" step="1" placeholder="Enter price" required>

            <label>Discount (%)</label>
            <input type="number" name="discount" placeholder="Enter discount" value="0.0" required>

            <label>Specifications</label>
            <table id="featuresTable" border="1" style="width:100%; border-collapse:collapse; margin-bottom:15px;">
                <thead style="background:#f9f9f9;">
                    <tr>
                        <th style="padding:8px; text-align:left;">Feature</th>
                        <th style="padding:8px; text-align:left;">Value</th>
                        <th style="padding:8px;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" name="feature[]" value="Color" required></td>
                        <td><input type="text" name="value[]" value="Black" required></td>
                        <td><button type="button" class="remove-btn">❌</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" onclick="addRow()" class="add-feature-btn">+ Add Feature</button>

            <textarea name="description" id="descriptionField" style="display:none;"></textarea>

            <label>Brand</label>
            <input type="text" name="brand" placeholder="Enter brand" value="No Brand" required>

            <div class="image-counter" id="imageCounter">0 images uploaded</div>
            <label>Upload Images</label>
            <div class="upload-box" onclick="document.getElementById('images').click()">
                <img src="https://cdn-icons-png.flaticon.com/512/1829/1829586.png" alt="Upload Icon">
                <p>Drop your image here, or <span style="color:#0295db;cursor:pointer;">browse</span></p>
                <p style="font-size:12px;">Supports: JPG, JPEG2000, PNG</p>
            </div>
            <input type="file" id="images" name="images" accept="image/*" multiple style="display:none">

            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <button type="submit" class="submit-btn">Add Product</button>
        </form>
    </div>

</div>

<script>
    const imageInput = document.getElementById('images');
    const imageCounter = document.getElementById('imageCounter');
    const progressBar = document.getElementById('progressBar');

    imageInput.addEventListener('change', function () {
        let count = imageInput.files.length;
        imageCounter.textContent = `${count} image${count !== 1 ? 's' : ''} uploaded`;

        progressBar.style.width = '0%';
        let progress = 0;
        let fakeUpload = setInterval(() => {
            if (progress >= 100) {
                clearInterval(fakeUpload);
            } else {
                progress += 10;
                progressBar.style.width = progress + '%';
            }
        }, 200);
    });

document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const tableBody = document.querySelector("#featuresTable tbody");
    const descriptionField = document.getElementById("descriptionField");

    // Add new feature row
    document.querySelector(".add-feature-btn").addEventListener("click", function () {
        let row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="text" name="feature[]" placeholder="Feature" required></td>
            <td><input type="text" name="value[]" placeholder="Value" required></td>
            <td><button type="button" class="remove-btn">❌</button></td>
        `;
        tableBody.appendChild(row);
    });

    // Remove row
    tableBody.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-btn")) {
            e.target.closest("tr").remove();
        }
    });

    // ✅ On submit → fill textarea with JSON
    form.addEventListener("submit", function () {
        let features = document.querySelectorAll("input[name='feature[]']");
        let values = document.querySelectorAll("input[name='value[]']");
        let data = {};

        features.forEach((f, i) => {
            if (f.value.trim() && values[i].value.trim()) {
                data[f.value.trim()] = values[i].value.trim();
            }
        });

        descriptionField.value = JSON.stringify(data);
        console.log("✅ Final JSON stored in textarea:", descriptionField.value);
    });
});
</script>

{% endblock %}